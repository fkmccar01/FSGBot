from flask import Flask, request
import requests
from bs4 import BeautifulSoup
import os

app = Flask(__name__)

X11_USERNAME = os.environ.get("itzaroni")
X11_PASSWORD = os.environ.get("itzaroni09")

LOGIN_URL = "https://www.xperteleven.com/front_new3.aspx"
MATCH_URL = "https://xperteleven.com/gameDetails.aspx?GameID=322737050&dh=2"

@app.route('/')
def home():
    return "X11 Scraper Bot is running."

@app.route('/scrape', methods=['GET'])
def scrape_match():
    with requests.Session() as session:
        login_payload = {
            "ctl00$cphMain$FrontControl$lwLogin$tbUsername": X11_USERNAME,
            "ctl00$cphMain$FrontControl$lwLogin$tbPassword": X11_PASSWORD,
            "ctl00$cphMain$FrontControl$lwLogin$btnLogin": "Login"
        }

        response = session.post(LOGIN_URL, data=login_payload)
        
        if "logout" not in response.text.lower():
            return "Login failed."

        match_page = session.get(MATCH_URL)
        soup = BeautifulSoup(match_page.text, 'html.parser')

        events = soup.find_all("tr", class_="ItemStyle2")
        summary = []

        for event in events:
            minute = event.find("span", class_="brotext10").text.strip()
            desc = event.find("span", {"id": lambda x: x and "lblEventDesc" in x})
            if desc:
                summary.append(f"{minute}': {desc.text.strip()}")

        return "<br>".join(summary)

if __name__ == '__main__':
    app.run(debug=True)
